from flask import Flask, render_template, request, jsonify, make_response, redirect

app = Flask(__name__, template_folder='../templates')

# --- APNA PASSWORD YAHAN SET KARO ---
ADMIN_PASS = "admin123" 

@app.route('/')
def home():
    # YAHAN HAI FIX: Agar login nahi hai, to Login Page par bhejo
    if request.cookies.get('logged_in') != 'true':
        return redirect('/login')
    return render_template('index.html')

@app.route('/login')
def login_page():
    # Agar pehle se login hai, to sidha Admin Panel dikhao (ya Tool)
    if request.cookies.get('logged_in') == 'true':
        return redirect('/admin')
    return render_template('login.html')

@app.route('/admin')
def admin_panel():
    if request.cookies.get('logged_in') != 'true':
        return redirect('/login')
    return render_template('admin.html')

# --- API LOGIC ---

@app.route('/api/login', methods=['POST'])
def api_login():
    data = request.json
    if data.get('pass') == ADMIN_PASS:
        resp = make_response(jsonify({"status": "success"}))
        # 1 Din ke liye login save rahega
        resp.set_cookie('logged_in', 'true', max_age=86400)
        return resp
    return jsonify({"status": "fail"}), 401

@app.route('/api/generate', methods=['POST'])
def api_generate():
    if request.cookies.get('logged_in') != 'true':
        return jsonify({"status": "error"}), 403
    
    import random, string
    data = request.json
    duration = data.get('duration', '1h')
    
    rand_str = ''.join(random.choices(string.ascii_uppercase + string.digits, k=5))
    new_key = f"EXE-{rand_str}-{duration.upper()}"
    
    return jsonify({"status": "success", "key": new_key})

@app.route('/api/logout')
def logout():
    resp = make_response(redirect('/login'))
    resp.set_cookie('logged_in', '', expires=0)
    return resp

if __name__ == '__main__':
    app.run(debug=True)
